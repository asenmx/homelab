name: Slack Commit Notification

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: ${{ github.event_name == 'pull_request' && 2 || 2 }}

      - name: Get changed files and lines and commit details
        id: changes
        run: |
          EVENT_TYPE=""
          COMMIT_AUTHOR=""
          COMMIT_TITLE=""
          BASE_REF=""
          HEAD_REF=""
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            EVENT_TYPE="Pull Request"
            BASE_REF="HEAD^1"
            HEAD_REF="HEAD"
            COMMIT_AUTHOR="${{ github.event.pull_request.user.login }}"
            COMMIT_TITLE="${{ github.event.pull_request.title }}"
          else
            EVENT_TYPE="Push Commit"
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.event.after }}"
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
            COMMIT_TITLE="${{ github.event.head_commit.message }}"
          fi
          CHANGED_FILES=$(git diff --name-only -r $BASE_REF $HEAD_REF | xargs)
          DIFF_STATS=$(git diff --shortstat $BASE_REF $HEAD_REF | xargs)
          LINES_ADDED=$(echo $DIFF_STATS | grep -oP '\K\d+(?=\s+insertion)')
          LINES_DELETED=$(echo $DIFF_STATS | grep -oP '\K\d+(?=\s+deletion)')
          LINES_ADDED=${LINES_ADDED:-0}
          LINES_DELETED=${LINES_DELETED:-0}
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            URL="${{ github.event.pull_request.html_url }}"
          else
            URL="${{ github.event.head_commit.url }}"
          fi
          
          echo "event_type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "commit_title=$COMMIT_TITLE" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "diff_stats=$DIFF_STATS" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
      - name: Send Detailed Commit/PR Slack Notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "New ${{ steps.changes.outputs.event_type }} on ${{ github.repository }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Type:*\n`${{ steps.changes.outputs.event_type }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ steps.changes.outputs.commit_author }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Files Changed:*\n`${{ steps.changes.outputs.diff_stats }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Commit Message:*\n>${{ steps.changes.outputs.commit_title }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "emoji": true,
                        "text": "+${{ steps.changes.outputs.lines_added }} Added"
                      },
                      "style": "primary",
                      "url": "${{ steps.changes.outputs.url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "emoji": true,
                        "text": "-${{ steps.changes.outputs.lines_deleted }} Deleted"
                      },
                      "style": "danger",
                      "url": "${{ steps.changes.outputs.url }}"
                    },
                    ]
                  }
                ]
              }
